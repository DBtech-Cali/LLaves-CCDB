<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Control de Pr茅stamos de Llaves</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .connection-status {
            position: absolute;
            top: 20px;
            right: 20px;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: 500;
        }

        .connection-status.connected {
            background: rgba(16, 172, 132, 0.9);
            color: white;
        }

        .connection-status.disconnected {
            background: rgba(255, 107, 107, 0.9);
            color: white;
        }

        .controls {
            padding: 30px;
            background: #f8f9fa;
            border-bottom: 1px solid #e9ecef;
            display: flex;
            gap: 20px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .control-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 25px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        .control-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }

        .main-content {
            padding: 30px;
        }

        .keys-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(60px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }

        .key-button {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            border: 3px solid #fff;
            background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
            color: #333;
            font-weight: bold;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .key-button:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 15px rgba(0,0,0,0.2);
        }

        .key-button.loaned {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(255, 107, 107, 0.3);
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 0;
            border-radius: 20px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 20px 40px rgba(0,0,0,0.2);
            animation: modalSlideIn 0.3s ease;
        }

        @keyframes modalSlideIn {
            from { transform: translateY(-50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .modal-header {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 20px;
            border-radius: 20px 20px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h2 {
            margin: 0;
        }

        .close {
            color: white;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            transition: color 0.3s ease;
        }

        .close:hover {
            color: #ddd;
        }

        .modal-body {
            padding: 30px;
        }

        .person-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
        }

        .person-button {
            background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
            border: 2px solid transparent;
            padding: 15px;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            font-weight: 500;
        }

        .person-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            border-color: #4facfe;
        }

        .report-section {
            display: none;
            background: #f8f9fa;
            border-radius: 15px;
            padding: 25px;
            margin-top: 20px;
        }

        .report-title {
            color: #333;
            font-size: 1.5em;
            margin-bottom: 20px;
            text-align: center;
        }

        .report-item {
            background: white;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .report-item .key-info {
            font-weight: bold;
            color: #4facfe;
        }

        .report-item .person-info {
            color: #666;
        }

        .report-item .date-info {
            color: #999;
            font-size: 0.9em;
        }

        .return-button {
            background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%);
            color: #333;
            border: none;
            padding: 8px 15px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.9em;
            transition: all 0.3s ease;
        }

        .return-button:hover {
            transform: scale(1.05);
            box-shadow: 0 3px 10px rgba(255, 154, 158, 0.3);
        }

        .search-box {
            width: 100%;
            padding: 15px;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            font-size: 1em;
            margin-bottom: 20px;
            transition: border-color 0.3s ease;
        }

        .search-box:focus {
            outline: none;
            border-color: #4facfe;
        }

        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-left: 10px;
        }

        .status-available {
            background-color: #10ac84;
        }

        .status-loaned {
            background-color: #ff6b6b;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }

        @media (max-width: 768px) {
            .keys-grid {
                grid-template-columns: repeat(auto-fill, minmax(50px, 1fr));
                gap: 10px;
            }

            .key-button {
                width: 50px;
                height: 50px;
                font-size: 12px;
            }

            .controls {
                flex-direction: column;
                align-items: center;
            }

            .control-btn {
                width: 100%;
                max-width: 300px;
            }

            .connection-status {
                position: static;
                margin: 10px auto;
                width: fit-content;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="connection-status" id="connectionStatus">Conectando...</div>
            <h1> Control de Pr茅stamos de Llaves</h1>
            <p>Sistema de gesti贸n y seguimiento de llaves con sincronizaci贸n en tiempo real</p>
        </div>

        <div class="controls">
            <button class="control-btn" onclick="showActiveLoans()"> Pr茅stamos Activos</button>
            <button class="control-btn" onclick="showHistory()"> Hist贸rico Completo</button>
            <button class="control-btn" onclick="exportData()"> Exportar Datos</button>
        </div>

        <div class="main-content">
            <div class="loading" id="loadingIndicator">Cargando datos...</div>
            
            <div class="keys-grid" id="keysGrid" style="display: none;">
                <!-- Los botones de llaves se generar谩n aqu铆 -->
            </div>

            <div class="report-section" id="activeLoansSection">
                <h3 class="report-title"> Pr茅stamos Activos</h3>
                <div id="activeLoansContent"></div>
            </div>

            <div class="report-section" id="historySection">
                <h3 class="report-title"> Hist贸rico de Pr茅stamos (ltimo Mes)</h3>
                <input type="text" class="search-box" id="historySearch" placeholder="Buscar en hist贸rico..." onkeyup="filterHistory()">
                <div id="historyContent"></div>
            </div>
        </div>
    </div>

    <!-- Modal para selecci贸n de persona -->
    <div id="personModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">Seleccionar Persona</h2>
                <span class="close" onclick="closeModal()">&times;</span>
            </div>
            <div class="modal-body">
                <input type="text" class="search-box" id="personSearch" placeholder="Buscar persona..." onkeyup="filterPersons()">
                <div class="person-grid" id="personGrid">
                    <!-- Las opciones de personas se generar谩n aqu铆 -->
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        // Importar Firebase
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getDatabase, ref, set, get, onValue, push, remove, orderByChild, query, limitToLast } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';

        // Configuraci贸n de Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyCvoqrko9FUHrGzAgov1HEcHZRHJDsn9Qo",
            authDomain: "ccdb-llaves.firebaseapp.com",
            databaseURL: "https://ccdb-llaves-default-rtdb.firebaseio.com",
            projectId: "ccdb-llaves",
            storageBucket: "ccdb-llaves.firebasestorage.app",
            messagingSenderId: "783029748907",
            appId: "1:783029748907:web:2a1a65c5d67d32240ea3ee"
        };

        // Inicializar Firebase
        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);

        // Variables globales
        let keyStatus = {};
        let loanHistory = [];
        let currentKey = null;
        let isConnected = false;

        // Lista de 50 personas
        const persons = [
            "Ana Garc铆a", "Carlos L贸pez", "Mar铆a Gonz谩lez", "Jos茅 Mart铆nez", "Laura Rodr铆guez",
            "Pedro S谩nchez", "Carmen Jim茅nez", "Francisco Ruiz", "Isabel Moreno", "Antonio Mu帽oz",
            "Rosa lvarez", "Manuel Romero", "Pilar Navarro", "ngel Torres", "Dolores Dom铆nguez",
            "Rafael V谩zquez", "Mercedes Ramos", "Ignacio Gil", "Concepci贸n Serrano", "Ram贸n Blanco",
            "Teresa Molina", "Enrique Castro", "Josefa Ortega", "Alejandro Rubio", "Francisca Delgado",
            "Tom谩s Herrera", "Antonia Flores", "Sergio Gallego", "Encarnaci贸n Aguilar", "Rub茅n Cabrera",
            "Roc铆o Fern谩ndez", "Adri谩n Prieto", "Amparo Cano", "V铆ctor Carmona", "Remedios Herrero",
            "Iv谩n Pe帽a", "Soledad Santana", "scar Le贸n", "Esperanza Mar铆n", "Nicol谩s Vega",
            "Milagros Gim茅nez", "Emilio Cort茅s", "Purificaci贸n Iglesias", "Joaqu铆n Lorenzo", "Asunci贸n Guerrero",
            "Esteban Mendoza", "Inmaculada Ferrer", "Gonzalo Medina", "Consolaci贸n Garrido", "F茅lix Ib谩帽ez"
        ];

        // Inicializar la aplicaci贸n
        async function initApp() {
            try {
                generateKeyButtons();
                await setupFirebaseListeners();
                hideLoading();
                updateConnectionStatus(true);
            } catch (error) {
                console.error('Error inicializando la app:', error);
                updateConnectionStatus(false);
                showNotification('Error de conexi贸n. Reintentando...', 'error');
                setTimeout(initApp, 5000);
            }
        }

        // Configurar listeners de Firebase
        async function setupFirebaseListeners() {
            // Listener para pr茅stamos activos
            const activeLoansRef = ref(database, 'activeLoans');
            onValue(activeLoansRef, (snapshot) => {
                const data = snapshot.val();
                keyStatus = data || {};
                updateAllKeyButtons();
                updateConnectionStatus(true);
            }, (error) => {
                console.error('Error en listener de pr茅stamos activos:', error);
                updateConnectionStatus(false);
            });

            // Listener para historial (煤ltimo mes)
            const oneMonthAgo = Date.now() - (30 * 24 * 60 * 60 * 1000);
            const historyRef = query(
                ref(database, 'loanHistory'), 
                orderByChild('timestamp'),
                limitToLast(1000)
            );
            
            onValue(historyRef, (snapshot) => {
                const data = snapshot.val();
                if (data) {
                    loanHistory = Object.values(data)
                        .filter(record => record.timestamp >= oneMonthAgo)
                        .sort((a, b) => b.timestamp - a.timestamp);
                } else {
                    loanHistory = [];
                }
            }, (error) => {
                console.error('Error en listener de historial:', error);
            });

            // Limpiar historial antiguo peri贸dicamente
            await cleanOldHistory();
        }

        // Limpiar historial antiguo (mayor a 1 mes)
        async function cleanOldHistory() {
            try {
                const historyRef = ref(database, 'loanHistory');
                const snapshot = await get(historyRef);
                const data = snapshot.val();
                
                if (data) {
                    const oneMonthAgo = Date.now() - (30 * 24 * 60 * 60 * 1000);
                    const promises = [];
                    
                    Object.keys(data).forEach(key => {
                        if (data[key].timestamp < oneMonthAgo) {
                            promises.push(remove(ref(database, `loanHistory/${key}`)));
                        }
                    });
                    
                    await Promise.all(promises);
                    console.log('Historial antiguo limpiado');
                }
            } catch (error) {
                console.error('Error limpiando historial:', error);
            }
        }

        // Actualizar estado de conexi贸n
        function updateConnectionStatus(connected) {
            isConnected = connected;
            const status = document.getElementById('connectionStatus');
            if (connected) {
                status.textContent = ' Conectado';
                status.className = 'connection-status connected';
            } else {
                status.textContent = ' Sin conexi贸n';
                status.className = 'connection-status disconnected';
            }
        }

        // Generar botones de llaves del 1 al 250
        function generateKeyButtons() {
            const grid = document.getElementById('keysGrid');
            grid.innerHTML = '';
            for (let i = 1; i <= 250; i++) {
                const button = document.createElement('button');
                button.className = 'key-button';
                button.textContent = i;
                button.onclick = () => openPersonModal(i);
                button.id = `key-${i}`;
                grid.appendChild(button);
            }
        }

        // Actualizar todos los botones de llaves
        function updateAllKeyButtons() {
            for (let i = 1; i <= 250; i++) {
                updateKeyButton(i);
            }
        }

        // Actualizar apariencia del bot贸n de llave
        function updateKeyButton(keyNumber) {
            const button = document.getElementById(`key-${keyNumber}`);
            if (!button) return;

            if (keyStatus[keyNumber]) {
                button.classList.add('loaned');
                button.title = `Prestada a: ${keyStatus[keyNumber].person}\nFecha: ${new Date(keyStatus[keyNumber].loanDate).toLocaleString('es-ES')}`;
            } else {
                button.classList.remove('loaned');
                button.title = `Llave ${keyNumber} - Disponible`;
            }
        }

        // Ocultar indicador de carga
        function hideLoading() {
            document.getElementById('loadingIndicator').style.display = 'none';
            document.getElementById('keysGrid').style.display = 'grid';
        }

        // Abrir modal de selecci贸n de persona
        function openPersonModal(keyNumber) {
            if (!isConnected) {
                showNotification('No hay conexi贸n a internet. Intenta m谩s tarde.', 'error');
                return;
            }

            currentKey = keyNumber;
            const modal = document.getElementById('personModal');
            const title = document.getElementById('modalTitle');
            
            if (keyStatus[keyNumber]) {
                title.textContent = `Llave ${keyNumber} - Prestada a: ${keyStatus[keyNumber].person}`;
            } else {
                title.textContent = `Llave ${keyNumber} - Seleccionar Persona`;
            }
            
            generatePersonButtons();
            modal.style.display = 'block';
        }

        // Generar botones de personas
        function generatePersonButtons() {
            const grid = document.getElementById('personGrid');
            grid.innerHTML = '';
            
            // Si la llave est谩 prestada, mostrar bot贸n de devoluci贸n
            if (keyStatus[currentKey]) {
                const returnButton = document.createElement('button');
                returnButton.className = 'person-button';
                returnButton.style.background = 'linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%)';
                returnButton.innerHTML = `<strong> DEVOLVER LLAVE</strong><br>Prestada a: ${keyStatus[currentKey].person}`;
                returnButton.onclick = () => returnKey(currentKey);
                grid.appendChild(returnButton);
                
                const separator = document.createElement('div');
                separator.style.gridColumn = '1 / -1';
                separator.style.height = '20px';
                grid.appendChild(separator);
            }
            
            // Mostrar todas las personas
            persons.forEach(person => {
                const button = document.createElement('button');
                button.className = 'person-button';
                button.textContent = person;
                button.onclick = () => loanKey(currentKey, person);
                grid.appendChild(button);
            });
        }

        // Filtrar personas en el modal
        function filterPersons() {
            const search = document.getElementById('personSearch').value.toLowerCase();
            const buttons = document.querySelectorAll('#personGrid .person-button');
            
            buttons.forEach(button => {
                if (button.textContent.toLowerCase().includes(search)) {
                    button.style.display = 'block';
                } else {
                    button.style.display = 'none';
                }
            });
        }

        // Prestar llave
        async function loanKey(keyNumber, person) {
            if (!isConnected) {
                showNotification('No hay conexi贸n a internet. Intenta m谩s tarde.', 'error');
                return;
            }

            try {
                const now = Date.now();
                const loanDate = new Date(now).toLocaleString('es-ES');
                
                // Si ya est谩 prestada, primero devolver
                if (keyStatus[keyNumber]) {
                    await returnKey(keyNumber);
                }
                
                // Registrar nuevo pr茅stamo
                const loanData = {
                    person: person,
                    loanDate: loanDate,
                    timestamp: now,
                    returnDate: null
                };

                // Actualizar pr茅stamos activos
                await set(ref(database, `activeLoans/${keyNumber}`), loanData);
                
                // Agregar al historial
                const historyData = {
                    keyNumber: keyNumber,
                    person: person,
                    loanDate: loanDate,
                    timestamp: now,
                    returnDate: null,
                    action: 'prestamo'
                };
                
                await push(ref(database, 'loanHistory'), historyData);
                
                closeModal();
                showNotification(` Llave ${keyNumber} prestada a ${person}`, 'success');
                
            } catch (error) {
                console.error('Error prestando llave:', error);
                showNotification('Error al prestar la llave. Intenta de nuevo.', 'error');
            }
        }

        // Devolver llave
        async function returnKey(keyNumber) {
            if (!isConnected) {
                showNotification('No hay conexi贸n a internet. Intenta m谩s tarde.', 'error');
                return;
            }

            if (!keyStatus[keyNumber]) return;

            try {
                const now = Date.now();
                const returnDate = new Date(now).toLocaleString('es-ES');
                const person = keyStatus[keyNumber].person;
                const loanDate = keyStatus[keyNumber].loanDate;
                
                // Agregar devoluci贸n al historial
                const historyData = {
                    keyNumber: keyNumber,
                    person: person,
                    loanDate: loanDate,
                    returnDate: returnDate,
                    timestamp: now,
                    action: 'devolucion'
                };
                
                await push(ref(database, 'loanHistory'), historyData);
                
                // Eliminar del estado activo
                await remove(ref(database, `activeLoans/${keyNumber}`));
                
                closeModal();
                showNotification(` Llave ${keyNumber} devuelta por ${person}`, 'success');
                
            } catch (error) {
                console.error('Error devolviendo llave:', error);
                showNotification('Error al devolver la llave. Intenta de nuevo.', 'error');
            }
        }

        // Mostrar pr茅stamos activos
        function showActiveLoans() {
            hideAllReports();
            const section = document.getElementById('activeLoansSection');
            const content = document.getElementById('activeLoansContent');
            
            content.innerHTML = '';
            
            const activeLoans = Object.keys(keyStatus).map(key => ({
                key: parseInt(key),
                ...keyStatus[key]
            })).sort((a, b) => a.key - b.key);
            
            if (activeLoans.length === 0) {
                content.innerHTML = '<div class="report-item"><span> No hay pr茅stamos activos en este momento</span></div>';
            } else {
                activeLoans.forEach(loan => {
                    const item = document.createElement('div');
                    item.className = 'report-item';
                    item.innerHTML = `
                        <div>
                            <span class="key-info"> Llave ${loan.key}</span>
                            <span class="status-indicator status-loaned"></span>
                        </div>
                        <div class="person-info"> ${loan.person}</div>
                        <div class="date-info"> ${loan.loanDate}</div>
                        <button class="return-button" onclick="returnKeyFromReport(${loan.key})"> Devolver</button>
                    `;
                    content.appendChild(item);
                });
            }
            
            section.style.display = 'block';
            section.scrollIntoView({ behavior: 'smooth' });
        }

        // Devolver llave desde el reporte
        window.returnKeyFromReport = async function(keyNumber) {
            await returnKey(keyNumber);
            showActiveLoans(); // Refrescar la vista
        };

        // Mostrar hist贸rico
        function showHistory() {
            hideAllReports();
            const section = document.getElementById('historySection');
            updateHistoryContent();
            section.style.display = 'block';
            section.scrollIntoView({ behavior: 'smooth' });
        }

        // Actualizar contenido del hist贸rico
        function updateHistoryContent() {
            const content = document.getElementById('historyContent');
            content.innerHTML = '';
            
            if (loanHistory.length === 0) {
                content.innerHTML = '<div class="report-item"><span> No hay registros en el hist贸rico a煤n</span></div>';
                return;
            }
            
            loanHistory.forEach(record => {
                const item = document.createElement('div');
                item.className = 'report-item';
                
                const actionText = record.action === 'prestamo' ? 'Pr茅stamo' : 'Devoluci贸n';
                const actionIcon = record.action === 'prestamo' ? '' : '';
                const statusClass = record.action === 'prestamo' ? 'status-loaned' : 'status-available';
                
                item.innerHTML = `
                    <div>
                        <span class="key-info">${actionIcon} Llave ${record.keyNumber}</span>
                        <span class="status-indicator ${statusClass}"></span>
                    </div>
                    <div class="person-info"> ${record.person}</div>
                    <div class="date-info">
                         ${actionText}: ${record.loanDate}
                        ${record.returnDate ? `<br> Devoluci贸n: ${record.returnDate}` : ''}
                    </div>
                `;
                content.appendChild(item);
            });
        }

        // Filtrar hist贸rico
        window.filterHistory = function() {
            const search = document.getElementById('historySearch').value.toLowerCase();
            const items = document.querySelectorAll('#historyContent .report-item');
            
            items.forEach(item => {
                if (item.textContent.toLowerCase().includes(search)) {
                    item.style.display = 'flex';
                } else {
                    item.style.display = 'none';
                }
            });
        };

        // Ocultar todos los reportes
        function hideAllReports() {
            document.getElementById('activeLoansSection').style.display = 'none';
            document.getElementById('historySection').style.display = 'none';
        }

        // Cerrar modal
        window.closeModal = function() {
            document.getElementById('personModal').style.display = 'none';
            document.getElementById('personSearch').value = '';
        };

        // Cerrar modal al hacer clic fuera
        window.onclick = function(event) {
            const modal = document.getElementById('personModal');
            if (event.target === modal) {
                closeModal();
            }
        };

        // Exportar datos
        window.exportData = function() {
            if (!isConnected) {
                showNotification('No hay conexi贸n a internet. Intenta m谩s tarde.', 'error');
                return;
            }

            const data = {
                prestamosActivos: keyStatus,
                historico: loanHistory,
                fechaExportacion: new Date().toLocaleString('es-ES'),
                totalLlavesDisponibles: 250 - Object.keys(keyStatus).length,
                totalLlavesPrestadas: Object.keys(keyStatus).length
            };
            
            const dataStr = JSON.stringify(data, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            
            const link = document.createElement('a');
            link.href = url;
            link.download = `prestamos_llaves_${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            
            showNotification(' Datos exportados exitosamente', 'success');
        };

        // Mostrar notificaciones
        function showNotification(message, type) {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: ${type === 'success' ? '#10ac84' : '#ff6b6b'};
                color: white;
                padding: 15px 25px;
                border-radius: 10px;
                z-index: 10000;
                box-shadow: 0 4px 15px rgba(0,0,0,0.2);
                animation: slideInRight 0.3s ease;
                max-width: 300px;
                word-wrap: break-word;
            `;
            
            // Agregar animaci贸n CSS
            const style = document.createElement('style');
            style.textContent = `
                @keyframes slideInRight {
                    from { transform: translateX(100%); opacity: 0; }
                    to { transform: translateX(0); opacity: 1; }
                }
                @keyframes slideOutRight {
                    from { transform: translateX(0); opacity: 1; }
                    to { transform: translateX(100%); opacity: 0; }
                }
            `;
            document.head.appendChild(style);
            
            notification.textContent = message;
            document.body.appendChild(notification);
            
            // Agregar funcionalidad de click para cerrar
            notification.addEventListener('click', () => {
                notification.style.animation = 'slideOutRight 0.3s ease';
                setTimeout(() => notification.remove(), 300);
            });
            
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.style.animation = 'slideOutRight 0.3s ease';
                    setTimeout(() => notification.remove(), 300);
                }
            }, 5000);
        }

        // Hacer funciones globales
        window.showActiveLoans = showActiveLoans;
        window.showHistory = showHistory;
        window.openPersonModal = openPersonModal;
        window.filterPersons = filterPersons;

        // Monitoreo de conexi贸n a internet
        function setupConnectionMonitoring() {
            window.addEventListener('online', () => {
                showNotification(' Conexi贸n restaurada', 'success');
                updateConnectionStatus(true);
            });

            window.addEventListener('offline', () => {
                showNotification(' Sin conexi贸n a internet', 'error');
                updateConnectionStatus(false);
            });
        }

        // Inicializar aplicaci贸n al cargar la p谩gina
        window.addEventListener('load', () => {
            initApp();
            setupConnectionMonitoring();
            
            // Limpiar historial antiguo cada 24 horas
            setInterval(cleanOldHistory, 24 * 60 * 60 * 1000);
        });

        // Manejar errores globales
        window.addEventListener('error', (event) => {
            console.error('Error global:', event.error);
            showNotification('Ocurri贸 un error inesperado. Recarga la p谩gina si persiste.', 'error');
        });

        // Prevenir cierre accidental de la p谩gina si hay cambios pendientes
        window.addEventListener('beforeunload', (event) => {
            if (!isConnected && Object.keys(keyStatus).length > 0) {
                event.preventDefault();
                event.returnValue = '';
                return 'Hay cambios que podr铆an perderse. 驴Est谩s seguro de salir?';
            }
        });

        // Funci贸n para reintentar conexi贸n
        async function retryConnection() {
            try {
                await initApp();
            } catch (error) {
                setTimeout(retryConnection, 5000);
            }
        }

        // Auto-reconexi贸n en caso de p茅rdida de conexi贸n
        setInterval(() => {
            if (!isConnected && navigator.onLine) {
                retryConnection();
            }
        }, 10000);

    </script>
</body>
</html>
