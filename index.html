<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Control de Pr√©stamos de Llaves</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .connection-status {
            position: absolute;
            top: 20px;
            right: 20px;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: 500;
        }

        .connection-status.connected {
            background: rgba(16, 172, 132, 0.9);
            color: white;
        }

        .connection-status.disconnected {
            background: rgba(255, 107, 107, 0.9);
            color: white;
        }

        .controls {
            padding: 30px;
            background: #f8f9fa;
            border-bottom: 1px solid #e9ecef;
            display: flex;
            gap: 20px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .control-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 25px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        .control-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }

        .main-content {
            padding: 30px;
        }

        .keys-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(60px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }

        .key-button {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            border: 3px solid #fff;
            background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
            color: #333;
            font-weight: bold;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .key-button:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 15px rgba(0,0,0,0.2);
        }

        .key-button.loaned {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(255, 107, 107, 0.3);
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 0;
            border-radius: 20px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 20px 40px rgba(0,0,0,0.2);
            animation: modalSlideIn 0.3s ease;
        }

        @keyframes modalSlideIn {
            from { transform: translateY(-50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .modal-header {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 20px;
            border-radius: 20px 20px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h2 {
            margin: 0;
        }

        .close {
            color: white;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            transition: color 0.3s ease;
        }

        .close:hover {
            color: #ddd;
        }

        .modal-body {
            padding: 30px;
        }

        .person-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
        }

        .person-button {
            background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
            border: 2px solid transparent;
            padding: 15px;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            font-weight: 500;
        }

        .person-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            border-color: #4facfe;
        }

        .report-section {
            display: none;
            background: #f8f9fa;
            border-radius: 15px;
            padding: 25px;
            margin-top: 20px;
        }

        .report-title {
            color: #333;
            font-size: 1.5em;
            margin-bottom: 20px;
            text-align: center;
        }

        .report-item {
            background: white;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .report-item .key-info {
            font-weight: bold;
            color: #4facfe;
        }

        .report-item .person-info {
            color: #666;
        }

        .report-item .date-info {
            color: #999;
            font-size: 0.9em;
        }

        .return-button {
            background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%);
            color: #333;
            border: none;
            padding: 8px 15px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.9em;
            transition: all 0.3s ease;
        }

        .return-button:hover {
            transform: scale(1.05);
            box-shadow: 0 3px 10px rgba(255, 154, 158, 0.3);
        }

        .search-box {
            width: 100%;
            padding: 15px;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            font-size: 1em;
            margin-bottom: 20px;
            transition: border-color 0.3s ease;
        }

        .search-box:focus {
            outline: none;
            border-color: #4facfe;
        }

        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-left: 10px;
        }

        .status-available {
            background-color: #10ac84;
        }

        .status-loaned {
            background-color: #ff6b6b;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }

        @media (max-width: 768px) {
            .keys-grid {
                grid-template-columns: repeat(auto-fill, minmax(50px, 1fr));
                gap: 10px;
            }

            .key-button {
                width: 50px;
                height: 50px;
                font-size: 12px;
            }

            .controls {
                flex-direction: column;
                align-items: center;
            }

            .control-btn {
                width: 100%;
                max-width: 300px;
            }

            .connection-status {
                position: static;
                margin: 10px auto;
                width: fit-content;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="connection-status" id="connectionStatus">Conectando...</div>
            <h1>üîë Control de Pr√©stamos de Llaves</h1>
            <p>Sistema de gesti√≥n y seguimiento de llaves con sincronizaci√≥n en tiempo real</p>
        </div>

        <div class="controls">
            <button class="control-btn" onclick="showActiveLoans()">üìã Pr√©stamos Activos</button>
            <button class="control-btn" onclick="showHistory()">üìö Hist√≥rico Completo</button>
            <button class="control-btn" onclick="showLocations()">üìç Ubicaciones</button>
        </div>

        <div class="main-content">
            <div class="loading" id="loadingIndicator">Cargando datos...</div>
            
            <div class="keys-grid" id="keysGrid" style="display: none;">
                <!-- Los botones de llaves se generar√°n aqu√≠ -->
            </div>

            <div class="report-section" id="activeLoansSection">
                <h3 class="report-title">üìã Pr√©stamos Activos</h3>
                <div id="activeLoansContent"></div>
            </div>

            <div class="report-section" id="historySection">
                <h3 class="report-title">üìö Hist√≥rico de Pr√©stamos (√öltimo Mes)</h3>
                <input type="text" class="search-box" id="historySearch" placeholder="Buscar en hist√≥rico..." onkeyup="filterHistory()">
                <div id="historyContent"></div>
            </div>
        </div>
    </div>

    <!-- Modal para ubicaciones -->
    <div id="locationsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>üìç Ubicaciones de Llaves</h2>
                <span class="close" onclick="closeLocationsModal()">&times;</span>
            </div>
            <div class="modal-body">
                <input type="text" class="search-box" id="locationSearch" placeholder="Buscar ubicaci√≥n o n√∫mero de llave..." onkeyup="filterLocations()">
                <div id="locationsContent">
                    <!-- Las ubicaciones se generar√°n aqu√≠ -->
                </div>
            </div>
        </div>
    </div>
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">Seleccionar Persona</h2>
                <span class="close" onclick="closeModal()">&times;</span>
            </div>
            <div class="modal-body">
                <input type="text" class="search-box" id="personSearch" placeholder="Buscar persona..." onkeyup="filterPersons()">
                <div class="person-grid" id="personGrid">
                    <!-- Las opciones de personas se generar√°n aqu√≠ -->
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        // Importar Firebase
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getDatabase, ref, set, get, onValue, push, remove, orderByChild, query, limitToLast } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';

        // Configuraci√≥n de Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyCvoqrko9FUHrGzAgov1HEcHZRHJDsn9Qo",
            authDomain: "ccdb-llaves.firebaseapp.com",
            databaseURL: "https://ccdb-llaves-default-rtdb.firebaseio.com",
            projectId: "ccdb-llaves",
            storageBucket: "ccdb-llaves.firebasestorage.app",
            messagingSenderId: "783029748907",
            appId: "1:783029748907:web:2a1a65c5d67d32240ea3ee"
        };

        // Inicializar Firebase
        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);

        // Variables globales
        let keyStatus = {};
        let loanHistory = [];
        let currentKey = null;
        let isConnected = false;

        // Lista de ubicaciones
        const locations = {
            1: "Direcci√≥n",
            2: "Contabilidad",
            3: "Llavero general",
            4: "Administraci√≥n",
            5: "Gesti√≥n Humana",
            6: "Ba√±o Admin Mujeres",
            7: "Ba√±o Admin Hombres",
            8: "ETDH",
            9: "Servidor",
            10: "Pastoral",
            11: "Comunicaciones",
            12: "SST y Ambiental",
            13: "Coordinaci√≥n ETDH",
            14: "Oficina",
            15: "Oficina",
            16: "Calidad",
            17: "SGI",
            18: "Deposito SST",
            "18.1": "Deposito SST - Reja",
            19: "Ba√±o SST",
            20: "Recepci√≥n",
            21: "Capilla",
            22: "Deposito Deportivo",
            23: "Nutrici√≥n EJC",
            24: "Psicolog√≠a EJC",
            25: "Coordinaci√≥n EJC",
            26: "Odontolog√≠a",
            27: "Ba√±o EJC",
            28: "Pedagog√≠a EJC",
            29: "Sal√≥n EJC",
            "29.1": "Bodega I EJC",
            "29.2": "Bodega 2 EJC",
            30: "Entrada Principal",
            31: "Estaci√≥n El√©ctrica",
            32: "Entrada Cocina PAZ",
            33: "Emisora",
            34: "Cafeter√≠a - Patio Central",
            35: "Enfermer√≠a",
            36: "Mantenimiento",
            37: "RPP",
            38: "Cafet√≠n",
            39: "Archivo",
            "39.1": "Archivo - Oficina",
            "39.2": "Archivo - Audiovisuales",
            40: "Audiovisuales",
            41: "SHUT",
            42: "Sal√≥n 1",
            43: "Puerta lateral T. Mec√°nica",
            44: "Almac√©n General",
            45: "Bodega Aseadores",
            46: "Vestier Aseadores",
            47: "Escuela de Artes DB",
            "47.1": "Escuela de Artes DB - Sal√≥n Interno",
            48: "Sal√≥n Teor√≠a 9",
            49: "Deposito de pastoral",
            50: "Sal√≥n Teor√≠a 8",
            51: "Sal√≥n Teor√≠a 7",
            52: "Sal√≥n Teor√≠a 6",
            53: "Sal√≥n Teor√≠a 5",
            54: "Cuarto de Aseo",
            55: "Sal√≥n Teor√≠a 2",
            56: "Sal√≥n Teor√≠a 3",
            57: "Sal√≥n Teor√≠a 4",
            58: "Sal√≥n Domingo Savio",
            59: "Taller Electricidad",
            "59.1": "T. Electricidad - Oficina",
            "59.2": "T. Electricidad - Deposito",
            60: "Sal√≥n Teor√≠a 10",
            61: "Taller Automatizaci√≥n",
            "61.1": "T. Automatizaci√≥n - Sal√≥n",
            "61.2": "T. Automatizaci√≥n - Bodega 1",
            "61.3": "T. Automatizaci√≥n - Bodega 2",
            "61.4": "T. Automatizaci√≥n - Neum√°tica",
            "61.5": "T. Automatizaci√≥n - Bodega 3",
            62: "Cafet√≠n 2¬∞ piso",
            63: "T. Automotriz - Entrada posterior 1",
            64: "T. Automotriz - Entrada posterior 2",
            65: "Dep√≥sito Materiales",
            67: "Taller de Mec√°nica Industrial",
            68: "T. Mec√°nica - Puerta posterior",
            69: "T. Mec√°nica - Dep√≥sito",
            71: "T. Automotriz - Entrada 2",
            72: "Taller Automotriz",
            73: "T. Automotriz - Entrada 3",
            74: "Mec√°nica Automotriz Port√≥n 1 y 2",
            75: "T. Automotriz - Herramientas 1",
            76: "T. Automotriz - Cuarto El√©ctrico",
            77: "T. Automotriz - Alineaci√≥n",
            78: "T. Automotriz - Herramientas 2",
            79: "Taller Soldadura",
            80: "T. Soldadura - Puerta lateral",
            81: "T. Soldadura - Puerta trasera",
            82: "T. Soldadura - Dep√≥sito",
            83: "T. Soldadura - Ventanilla",
            84: "Dep√≥sito de Pinturas",
            85: "Reciclaje",
            86: "Valdocco - Sala Sistemas",
            87: "Valdocco - Biblioteca",
            88: "Valdocco - Deposito",
            89: "Taller de confecciones",
            90: "Taller de confecciones 2",
            91: "Entrada Cocina para la Paz",
            "91.1": "Taller de Cocina",
            "91.2": "Oficina Jefe de Cocina",
            "91.3": "Aula de Formaci√≥n I",
            "91.4": "Cocina - Catering",
            "91.5": "Aula de Formaci√≥n II",
            "91.6": "Aula de formaci√≥n III",
            "91.7": "Bodega Catering",
            "91.8": "Reja trasera",
            "91.9": "Conexi√≥n a Cocina General",
            92: "Cocina General",
            "92.1": "Cocina - Candado Porton",
            "92.2": "Cocina - Binestarina",
            "92.3": "Cocina - Secos",
            "92.4": "Cocina - Vestier",
            "92.5": "Cocina - Aseo",
            "92.6": "Cocina - Conexi√≥n Paz",
            "92.7": "Cocina - Menaje",
            "92.8": "Cocina - Almacenamiento",
            "92.9": "Cocina - Cuartos Frios",
            "92.10": "Cocina - Salida lateral",
            "92.11": "Cocina - Tablero el√©ctrico",
            93: "Valdocco - Dormitorio Mujeres",
            "93.1": "Valdocco - Dormitorio Mujeres Vidrio",
            "93.2": "Valdocco - Patio y Ba√±os Mujeres",
            "93.3": "Valdocco - Ba√±o Disc Mujeres",
            94: "Valdocco - Entrada Principal",
            "94.1": "Valdocco - Lava traperos",
            95: "Valdocco - Dormitorio Hombres 1",
            "95.1": "Valdocco - Dormitorio Hombres Vidrio",
            "95.2": "Valdocco - Patio y Ba√±os hombres",
            "95.3": "Valdocco - Ba√±o Disc Hombres",
            "95.4": "Valdocco - Cuarto de Salud",
            96: "Valdocco - Dormitorio Hombres 2",
            97: "Valdocco - Habitaci√≥n Educador",
            98: "Valdocco - Ba√±os 2¬∞ Piso",
            99: "I Becchi (Techos)",
            100: "I Becchi - Entrada",
            101: "Habitaci√≥n 101",
            102: "Habitaci√≥n 102",
            103: "I Becchi - Sala TV",
            104: "Habitaci√≥n 104",
            105: "Habitaci√≥n 105",
            106: "Habitaci√≥n 106",
            107: "Habitaci√≥n 107",
            108: "Habitaci√≥n 108",
            109: "Habitaci√≥n 109",
            110: "Habitaci√≥n 110",
            111: "Habitaci√≥n 111",
            112: "I Becchi - Balc√≥n",
            113: "Casa SDB",
            114: "Habitaci√≥n 1",
            115: "Habitaci√≥n 2",
            116: "Ba√±o Social SDB",
            117: "Habitaci√≥n 3",
            119: "Patio Casa SDB",
            120: "Entrada Patio Casa SDB",
            121: "Capilla",
            122: "Habitaci√≥n 4",
            123: "Habitaci√≥n 5",
            124: "Ba√±o Social SDB 2¬∞ Piso",
            125: "Ba√±o EMJ",
            126: "Cuarto El√©ctrico",
            127: "Sal√≥n EMJ I",
            128: "Sal√≥n EMJ II",
            129: "TS y pedagog√≠a EMJ",
            130: "Coordinaci√≥n EMJ",
            131: "Coordinaci√≥n CV",
            132: "Psicolog√≠a CV",
            133: "Sal√≥n teor√≠a CV",
            134: "Macondo EMJ",
            135: "Pedagog√≠a CV",
            136: "Ba√±o CV",
            137: "Ba√±o Mujeres 2¬∞ piso",
            138: "Dep√≥sito ba√±o mujeres",
            139: "Sala de sistemas 1",
            140: "Sala de sistemas 2",
            141: "Sala de sistemas 3",
            142: "Sala de sistemas 4",
            143: "Sala de sistemas 5",
            144: "Sala de sistemas 6",
            145: "Ba√±o Hombres 2¬∞ piso",
            147: "Taller Sistemas",
            148: "T. Sistemas - Deposito",
            149: "T. Sistemas - Deposito 2",
            150: "T. Sistemas - Oficina 2",
            151: "T. Sistemas - Oficina",
            152: "Sal√≥n Mauxi - Entrada",
            153: "Auditorio Mauxi",
            154: "T. Sistemas - Deposito 3",
            155: "Sal√≥n Mauxi - Dep√≥sito",
            156: "Auditorio Mauxi - Dep√≥sito",
            157: "Aula 1",
            158: "Aula 2",
            159: "Aula 3",
            160: "Candado Entrada",
            161: "Garita Porter√≠a",
            162: "Vestier Porter√≠a",
            163: "Port√≥n Principal",
            164: "Porter√≠a - entrada veh√≠culos",
            165: "Port√≥n Carrera 33",
            166: "Garita Porter√≠a Crr 33",
            168: "Archivo EMJ",
            169: "Ba√±o Equipo EMJ",
            170: "Nutrici√≥n EMJ",
            171: "Psicolog√≠a EMJ",
            172: "Trabajo Social CV",
            173: "Nutrici√≥n CV",
            174: "Contador Electrico",
            184: "Innovaci√≥n - Cuarto El√©ctrico",
            185: "Innovaci√≥n - Cuarto Aseo",
            186: "Innovaci√≥n - Ingreso Patio",
            187: "Innovaci√≥n - Ba√±o Social",
            188: "Innovaci√≥n - Dormitorio Ba√±o",
            189: "Innovaci√≥n - Dormitorio",
            "189.1": "Innovaci√≥n - Dormitorio Patio",
            190: "Innovaci√≥n - Dormitorio2",
            191: "Innovaci√≥n - Peluquer√≠a",
            "191.1": "Innovaci√≥n - Peluquer√≠a Patio",
            192: "Innovaci√≥n - Deporte",
            "192.1": "Innovaci√≥n - Deporte Patio",
            193: "Innovaci√≥n - Deporte2",
            194: "Innovaci√≥n - Deporte3",
            195: "Innovaci√≥n - Arte",
            "195.1": "Innovaci√≥n - Arte Patio",
            196: "Innovaci√≥n - Arte2",
            197: "Innovaci√≥n - Arte3",
            198: "Innovaci√≥n - Joyer√≠a",
            "198.1": "Innovaci√≥n - Joyer√≠a Deposito",
            199: "Innovaci√≥n - Joyeria2",
            200: "Innovaci√≥n - Patio 1",
            201: "Innovaci√≥n - Coworking",
            "201.1": "Innovaci√≥n - Coworking Deposito",
            "201.2": "Innovaci√≥n - Coworking Patios",
            202: "Innovaci√≥n - Coworking2",
            203: "Innovaci√≥n - Ba√±o Mujeres",
            204: "Innovaci√≥n - Patio 2",
            205: "Innovaci√≥n - Ba√±o Hombres",
            206: "Innovaci√≥n - Eco Sal√≥n",
            "206.1": "Innovaci√≥n - Eco Sal√≥n Patio",
            207: "Innovaci√≥n - Eco Sal√≥n2"
        };

        // Lista de 50 personas
        const persons = [
            "Ana Garc√≠a", "Carlos L√≥pez", "Mar√≠a Gonz√°lez", "Jos√© Mart√≠nez", "Laura Rodr√≠guez",
            "Pedro S√°nchez", "Carmen Jim√©nez", "Francisco Ruiz", "Isabel Moreno", "Antonio Mu√±oz",
            "Rosa √Ålvarez", "Manuel Romero", "Pilar Navarro", "√Ångel Torres", "Dolores Dom√≠nguez",
            "Rafael V√°zquez", "Mercedes Ramos", "Ignacio Gil", "Concepci√≥n Serrano", "Ram√≥n Blanco",
            "Teresa Molina", "Enrique Castro", "Josefa Ortega", "Alejandro Rubio", "Francisca Delgado",
            "Tom√°s Herrera", "Antonia Flores", "Sergio Gallego", "Encarnaci√≥n Aguilar", "Rub√©n Cabrera",
            "Roc√≠o Fern√°ndez", "Adri√°n Prieto", "Amparo Cano", "V√≠ctor Carmona", "Remedios Herrero",
            "Iv√°n Pe√±a", "Soledad Santana", "√ìscar Le√≥n", "Esperanza Mar√≠n", "Nicol√°s Vega",
            "Milagros Gim√©nez", "Emilio Cort√©s", "Purificaci√≥n Iglesias", "Joaqu√≠n Lorenzo", "Asunci√≥n Guerrero",
            "Esteban Mendoza", "Inmaculada Ferrer", "Gonzalo Medina", "Consolaci√≥n Garrido", "F√©lix Ib√°√±ez"
        ];

        // Inicializar la aplicaci√≥n
        async function initApp() {
            try {
                generateKeyButtons();
                await setupFirebaseListeners();
                hideLoading();
                updateConnectionStatus(true);
            } catch (error) {
                console.error('Error inicializando la app:', error);
                updateConnectionStatus(false);
                showNotification('Error de conexi√≥n. Reintentando...', 'error');
                setTimeout(initApp, 5000);
            }
        }

        // Configurar listeners de Firebase
        async function setupFirebaseListeners() {
            // Listener para pr√©stamos activos
            const activeLoansRef = ref(database, 'activeLoans');
            onValue(activeLoansRef, (snapshot) => {
                const data = snapshot.val();
                keyStatus = data || {};
                updateAllKeyButtons();
                updateConnectionStatus(true);
            }, (error) => {
                console.error('Error en listener de pr√©stamos activos:', error);
                updateConnectionStatus(false);
            });

            // Listener para historial (√∫ltimo mes)
            const oneMonthAgo = Date.now() - (30 * 24 * 60 * 60 * 1000);
            const historyRef = query(
                ref(database, 'loanHistory'), 
                orderByChild('timestamp'),
                limitToLast(1000)
            );
            
            onValue(historyRef, (snapshot) => {
                const data = snapshot.val();
                if (data) {
                    loanHistory = Object.values(data)
                        .filter(record => record.timestamp >= oneMonthAgo)
                        .sort((a, b) => b.timestamp - a.timestamp);
                } else {
                    loanHistory = [];
                }
            }, (error) => {
                console.error('Error en listener de historial:', error);
            });

            // Limpiar historial antiguo peri√≥dicamente
            await cleanOldHistory();
        }

        // Limpiar historial antiguo (mayor a 1 mes)
        async function cleanOldHistory() {
            try {
                const historyRef = ref(database, 'loanHistory');
                const snapshot = await get(historyRef);
                const data = snapshot.val();
                
                if (data) {
                    const oneMonthAgo = Date.now() - (30 * 24 * 60 * 60 * 1000);
                    const promises = [];
                    
                    Object.keys(data).forEach(key => {
                        if (data[key].timestamp < oneMonthAgo) {
                            promises.push(remove(ref(database, `loanHistory/${key}`)));
                        }
                    });
                    
                    await Promise.all(promises);
                    console.log('Historial antiguo limpiado');
                }
            } catch (error) {
                console.error('Error limpiando historial:', error);
            }
        }

        // Actualizar estado de conexi√≥n
        function updateConnectionStatus(connected) {
            isConnected = connected;
            const status = document.getElementById('connectionStatus');
            if (connected) {
                status.textContent = 'üü¢ Conectado';
                status.className = 'connection-status connected';
            } else {
                status.textContent = 'üî¥ Sin conexi√≥n';
                status.className = 'connection-status disconnected';
            }
        }

        // Generar botones de llaves del 1 al 250
        function generateKeyButtons() {
            const grid = document.getElementById('keysGrid');
            grid.innerHTML = '';
            for (let i = 1; i <= 250; i++) {
                const button = document.createElement('button');
                button.className = 'key-button';
                button.textContent = i;
                button.onclick = () => openPersonModal(i);
                button.id = `key-${i}`;
                grid.appendChild(button);
            }
        }

        // Actualizar todos los botones de llaves
        function updateAllKeyButtons() {
            for (let i = 1; i <= 250; i++) {
                updateKeyButton(i);
            }
        }

        // Actualizar apariencia del bot√≥n de llave
        function updateKeyButton(keyNumber) {
            const button = document.getElementById(`key-${keyNumber}`);
            if (!button) return;

            if (keyStatus[keyNumber]) {
                button.classList.add('loaned');
                button.title = `Prestada a: ${keyStatus[keyNumber].person}\nFecha: ${new Date(keyStatus[keyNumber].loanDate).toLocaleString('es-ES')}`;
            } else {
                button.classList.remove('loaned');
                button.title = `Llave ${keyNumber} - Disponible`;
            }
        }

        // Ocultar indicador de carga
        function hideLoading() {
            document.getElementById('loadingIndicator').style.display = 'none';
            document.getElementById('keysGrid').style.display = 'grid';
        }

        // Abrir modal de selecci√≥n de persona
        function openPersonModal(keyNumber) {
            if (!isConnected) {
                showNotification('No hay conexi√≥n a internet. Intenta m√°s tarde.', 'error');
                return;
            }

            currentKey = keyNumber;
            const modal = document.getElementById('personModal');
            const title = document.getElementById('modalTitle');
            
            if (keyStatus[keyNumber]) {
                title.textContent = `Llave ${keyNumber} - Prestada a: ${keyStatus[keyNumber].person}`;
            } else {
                title.textContent = `Llave ${keyNumber} - Seleccionar Persona`;
            }
            
            generatePersonButtons();
            modal.style.display = 'block';
        }

        // Generar botones de personas
        function generatePersonButtons() {
            const grid = document.getElementById('personGrid');
            grid.innerHTML = '';
            
            // Si la llave est√° prestada, mostrar bot√≥n de devoluci√≥n
            if (keyStatus[currentKey]) {
                const returnButton = document.createElement('button');
                returnButton.className = 'person-button';
                returnButton.style.background = 'linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%)';
                returnButton.innerHTML = `<strong>üîÑ DEVOLVER LLAVE</strong><br>Prestada a: ${keyStatus[currentKey].person}`;
                returnButton.onclick = () => returnKey(currentKey);
                grid.appendChild(returnButton);
                
                const separator = document.createElement('div');
                separator.style.gridColumn = '1 / -1';
                separator.style.height = '20px';
                grid.appendChild(separator);
            }
            
            // Mostrar todas las personas
            persons.forEach(person => {
                const button = document.createElement('button');
                button.className = 'person-button';
                button.textContent = person;
                button.onclick = () => loanKey(currentKey, person);
                grid.appendChild(button);
            });
        }

        // Filtrar personas en el modal
        function filterPersons() {
            const search = document.getElementById('personSearch').value.toLowerCase();
            const buttons = document.querySelectorAll('#personGrid .person-button');
            
            buttons.forEach(button => {
                if (button.textContent.toLowerCase().includes(search)) {
                    button.style.display = 'block';
                } else {
                    button.style.display = 'none';
                }
            });
        }

        // Prestar llave
        async function loanKey(keyNumber, person) {
            if (!isConnected) {
                showNotification('No hay conexi√≥n a internet. Intenta m√°s tarde.', 'error');
                return;
            }

            try {
                const now = Date.now();
                const loanDate = new Date(now).toLocaleString('es-ES');
                
                // Si ya est√° prestada, primero devolver
                if (keyStatus[keyNumber]) {
                    await returnKey(keyNumber);
                }
                
                // Registrar nuevo pr√©stamo
                const loanData = {
                    person: person,
                    loanDate: loanDate,
                    timestamp: now,
                    returnDate: null
                };

                // Actualizar pr√©stamos activos
                await set(ref(database, `activeLoans/${keyNumber}`), loanData);
                
                // Agregar al historial
                const historyData = {
                    keyNumber: keyNumber,
                    person: person,
                    loanDate: loanDate,
                    timestamp: now,
                    returnDate: null,
                    action: 'prestamo'
                };
                
                await push(ref(database, 'loanHistory'), historyData);
                
                closeModal();
                showNotification(`üîë Llave ${keyNumber} prestada a ${person}`, 'success');
                
            } catch (error) {
                console.error('Error prestando llave:', error);
                showNotification('Error al prestar la llave. Intenta de nuevo.', 'error');
            }
        }

        // Devolver llave
        async function returnKey(keyNumber) {
            if (!isConnected) {
                showNotification('No hay conexi√≥n a internet. Intenta m√°s tarde.', 'error');
                return;
            }

            if (!keyStatus[keyNumber]) return;

            try {
                const now = Date.now();
                const returnDate = new Date(now).toLocaleString('es-ES');
                const person = keyStatus[keyNumber].person;
                const loanDate = keyStatus[keyNumber].loanDate;
                
                // Agregar devoluci√≥n al historial
                const historyData = {
                    keyNumber: keyNumber,
                    person: person,
                    loanDate: loanDate,
                    returnDate: returnDate,
                    timestamp: now,
                    action: 'devolucion'
                };
                
                await push(ref(database, 'loanHistory'), historyData);
                
                // Eliminar del estado activo
                await remove(ref(database, `activeLoans/${keyNumber}`));
                
                closeModal();
                showNotification(`üîÑ Llave ${keyNumber} devuelta por ${person}`, 'success');
                
            } catch (error) {
                console.error('Error devolviendo llave:', error);
                showNotification('Error al devolver la llave. Intenta de nuevo.', 'error');
            }
        }

        // Mostrar pr√©stamos activos
        function showActiveLoans() {
            hideAllReports();
            const section = document.getElementById('activeLoansSection');
            const content = document.getElementById('activeLoansContent');
            
            content.innerHTML = '';
            
            const activeLoans = Object.keys(keyStatus).map(key => ({
                key: parseInt(key),
                ...keyStatus[key]
            })).sort((a, b) => a.key - b.key);
            
            if (activeLoans.length === 0) {
                content.innerHTML = '<div class="report-item"><span>üî≠ No hay pr√©stamos activos en este momento</span></div>';
            } else {
                activeLoans.forEach(loan => {
                    const item = document.createElement('div');
                    item.className = 'report-item';
                    item.innerHTML = `
                        <div>
                            <span class="key-info">üîë Llave ${loan.key}</span>
                            <span class="status-indicator status-loaned"></span>
                        </div>
                        <div class="person-info">üë§ ${loan.person}</div>
                        <div class="date-info">üìÖ ${loan.loanDate}</div>
                        <button class="return-button" onclick="returnKeyFromReport(${loan.key})">üîÑ Devolver</button>
                    `;
                    content.appendChild(item);
                });
            }
            
            section.style.display = 'block';
            section.scrollIntoView({ behavior: 'smooth' });
        }

        // Devolver llave desde el reporte
        window.returnKeyFromReport = async function(keyNumber) {
            await returnKey(keyNumber);
            showActiveLoans(); // Refrescar la vista
        };

        // Mostrar hist√≥rico
        function showHistory() {
            hideAllReports();
            const section = document.getElementById('historySection');
            updateHistoryContent();
            section.style.display = 'block';
            section.scrollIntoView({ behavior: 'smooth' });
        }

        // Actualizar contenido del hist√≥rico
        function updateHistoryContent() {
            const content = document.getElementById('historyContent');
            content.innerHTML = '';
            
            if (loanHistory.length === 0) {
                content.innerHTML = '<div class="report-item"><span>üìö No hay registros en el hist√≥rico a√∫n</span></div>';
                return;
            }
            
            loanHistory.forEach(record => {
                const item = document.createElement('div');
                item.className = 'report-item';
                
                const actionText = record.action === 'prestamo' ? 'Pr√©stamo' : 'Devoluci√≥n';
                const actionIcon = record.action === 'prestamo' ? 'üì§' : 'üì•';
                const statusClass = record.action === 'prestamo' ? 'status-loaned' : 'status-available';
                
                item.innerHTML = `
                    <div>
                        <span class="key-info">${actionIcon} Llave ${record.keyNumber}</span>
                        <span class="status-indicator ${statusClass}"></span>
                    </div>
                    <div class="person-info">üë§ ${record.person}</div>
                    <div class="date-info">
                        üìÖ ${actionText}: ${record.loanDate}
                        ${record.returnDate ? `<br>üîÑ Devoluci√≥n: ${record.returnDate}` : ''}
                    </div>
                `;
                content.appendChild(item);
            });
        }

        // Filtrar hist√≥rico
        window.filterHistory = function() {
            const search = document.getElementById('historySearch').value.toLowerCase();
            const items = document.querySelectorAll('#historyContent .report-item');
            
            items.forEach(item => {
                if (item.textContent.toLowerCase().includes(search)) {
                    item.style.display = 'flex';
                } else {
                    item.style.display = 'none';
                }
            });
        };

        // Ocultar todos los reportes
        function hideAllReports() {
            document.getElementById('activeLoansSection').style.display = 'none';
            document.getElementById('historySection').style.display = 'none';
        }

        // Cerrar modal
        window.closeModal = function() {
            document.getElementById('personModal').style.display = 'none';
            document.getElementById('personSearch').value = '';
        };

        // Cerrar modal al hacer clic fuera
        window.onclick = function(event) {
            const personModal = document.getElementById('personModal');
            const locationsModal = document.getElementById('locationsModal');
            
            if (event.target === personModal) {
                closeModal();
            } else if (event.target === locationsModal) {
                closeLocationsModal();
            }
        };

        // Mostrar ubicaciones
        function showLocations() {
            const modal = document.getElementById('locationsModal');
            const content = document.getElementById('locationsContent');
            
            content.innerHTML = '';
            
            // Crear lista de ubicaciones ordenadas por n√∫mero
            const sortedLocations = Object.keys(locations).sort((a, b) => {
                const numA = parseFloat(a);
                const numB = parseFloat(b);
                return numA - numB;
            });
            
            sortedLocations.forEach(keyNumber => {
                const item = document.createElement('div');
                item.className = 'report-item';
                
                // Verificar si la llave est√° prestada
                const isLoaned = keyStatus[keyNumber];
                const statusClass = isLoaned ? 'status-loaned' : 'status-available';
                const statusText = isLoaned ? `Prestada a: ${keyStatus[keyNumber].person}` : 'Disponible';
                const statusIcon = isLoaned ? 'üîí' : 'üîì';
                
                item.innerHTML = `
                    <div>
                        <span class="key-info">${statusIcon} Llave ${keyNumber}</span>
                        <span class="status-indicator ${statusClass}"></span>
                    </div>
                    <div class="person-info">üìç ${locations[keyNumber]}</div>
                    <div class="date-info">${statusText}</div>
                `;
                
                // Si est√° prestada, agregar bot√≥n para abrir modal de persona
                if (isLoaned) {
                    const actionButton = document.createElement('button');
                    actionButton.className = 'return-button';
                    actionButton.textContent = 'üëÅÔ∏è Ver';
                    actionButton.onclick = () => {
                        closeLocationsModal();
                        openPersonModal(parseInt(keyNumber));
                    };
                    item.appendChild(actionButton);
                }
                
                content.appendChild(item);
            });
            
            modal.style.display = 'block';
        }

        // Filtrar ubicaciones
        window.filterLocations = function() {
            const search = document.getElementById('locationSearch').value.toLowerCase();
            const items = document.querySelectorAll('#locationsContent .report-item');
            
            items.forEach(item => {
                const text = item.textContent.toLowerCase();
                if (text.includes(search)) {
                    item.style.display = 'flex';
                } else {
                    item.style.display = 'none';
                }
            });
        };

        // Cerrar modal de ubicaciones
        window.closeLocationsModal = function() {
            document.getElementById('locationsModal').style.display = 'none';
            document.getElementById('locationSearch').value = '';
            // Mostrar todos los elementos de nuevo
            const items = document.querySelectorAll('#locationsContent .report-item');
            items.forEach(item => {
                item.style.display = 'flex';
            });
        };

        // Hacer funci√≥n global
        window.showLocations = showLocations;

        // Mostrar notificaciones
        function showNotification(message, type) {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: ${type === 'success' ? '#10ac84' : '#ff6b6b'};
                color: white;
                padding: 15px 25px;
                border-radius: 10px;
                z-index: 10000;
                box-shadow: 0 4px 15px rgba(0,0,0,0.2);
                animation: slideInRight 0.3s ease;
                max-width: 300px;
                word-wrap: break-word;
            `;
            
            // Agregar animaci√≥n CSS
            const style = document.createElement('style');
            style.textContent = `
                @keyframes slideInRight {
                    from { transform: translateX(100%); opacity: 0; }
                    to { transform: translateX(0); opacity: 1; }
                }
                @keyframes slideOutRight {
                    from { transform: translateX(0); opacity: 1; }
                    to { transform: translateX(100%); opacity: 0; }
                }
            `;
            document.head.appendChild(style);
            
            notification.textContent = message;
            document.body.appendChild(notification);
            
            // Agregar funcionalidad de click para cerrar
            notification.addEventListener('click', () => {
                notification.style.animation = 'slideOutRight 0.3s ease';
                setTimeout(() => notification.remove(), 300);
            });
            
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.style.animation = 'slideOutRight 0.3s ease';
                    setTimeout(() => notification.remove(), 300);
                }
            }, 5000);
        }

        // Hacer funciones globales
        window.showActiveLoans = showActiveLoans;
        window.showHistory = showHistory;
        window.openPersonModal = openPersonModal;
        window.filterPersons = filterPersons;

        // Monitoreo de conexi√≥n a internet
        function setupConnectionMonitoring() {
            window.addEventListener('online', () => {
                showNotification('üü¢ Conexi√≥n restaurada', 'success');
                updateConnectionStatus(true);
            });

            window.addEventListener('offline', () => {
                showNotification('üî¥ Sin conexi√≥n a internet', 'error');
                updateConnectionStatus(false);
            });
        }

        // Inicializar aplicaci√≥n al cargar la p√°gina
        window.addEventListener('load', () => {
            initApp();
            setupConnectionMonitoring();
            
            // Limpiar historial antiguo cada 24 horas
            setInterval(cleanOldHistory, 24 * 60 * 60 * 1000);
        });

        // Manejar errores globales
        window.addEventListener('error', (event) => {
            console.error('Error global:', event.error);
            showNotification('Ocurri√≥ un error inesperado. Recarga la p√°gina si persiste.', 'error');
        });

        // Prevenir cierre accidental de la p√°gina si hay cambios pendientes
        window.addEventListener('beforeunload', (event) => {
            if (!isConnected && Object.keys(keyStatus).length > 0) {
                event.preventDefault();
                event.returnValue = '';
                return 'Hay cambios que podr√≠an perderse. ¬øEst√°s seguro de salir?';
            }
        });

        // Funci√≥n para reintentar conexi√≥n
        async function retryConnection() {
            try {
                await initApp();
            } catch (error) {
                setTimeout(retryConnection, 5000);
            }
        }

        // Auto-reconexi√≥n en caso de p√©rdida de conexi√≥n
        setInterval(() => {
            if (!isConnected && navigator.onLine) {
                retryConnection();
            }
        }, 10000);

    </script>
</body>
</html>
